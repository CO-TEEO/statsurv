<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>An introduction to statsurv</title>

<script src="data:application/javascript;base64,Ly8gUGFuZG9jIDIuOSBhZGRzIGF0dHJpYnV0ZXMgb24gYm90aCBoZWFkZXIgYW5kIGRpdi4gV2UgcmVtb3ZlIHRoZSBmb3JtZXIgKHRvCi8vIGJlIGNvbXBhdGlibGUgd2l0aCB0aGUgYmVoYXZpb3Igb2YgUGFuZG9jIDwgMi44KS4KZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGZ1bmN0aW9uKGUpIHsKICB2YXIgaHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCJkaXYuc2VjdGlvbltjbGFzcyo9J2xldmVsJ10gPiA6Zmlyc3QtY2hpbGQiKTsKICB2YXIgaSwgaCwgYTsKICBmb3IgKGkgPSAwOyBpIDwgaHMubGVuZ3RoOyBpKyspIHsKICAgIGggPSBoc1tpXTsKICAgIGlmICghL15oWzEtNl0kL2kudGVzdChoLnRhZ05hbWUpKSBjb250aW51ZTsgIC8vIGl0IHNob3VsZCBiZSBhIGhlYWRlciBoMS1oNgogICAgYSA9IGguYXR0cmlidXRlczsKICAgIHdoaWxlIChhLmxlbmd0aCA+IDApIGgucmVtb3ZlQXR0cmlidXRlKGFbMF0ubmFtZSk7CiAgfQp9KTsK"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<link rel="stylesheet" href="data:text/css,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" type="text/css" />




</head>

<body>




<h1 class="title toc-ignore">An introduction to <code>statsurv</code></h1>



<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(statsurv)</span></code></pre></div>
<div id="overview" class="section level2">
<h2>Overview</h2>
<p>Statistical surveillance is any sort of systematic, ongoing analysis aimed at detecting changes in outcomes as they occur. This process requires developing a model to predict the outcome of interest, and then systematically examining the measured outcomes as they occur and determining when the observed outcomes no longer match the predicted outcomes. If the amount of data reported is large or if there is significant natural variability in the rate of case events, statistical techniques can be extremely helpful in determining when a change in the number of events is important, and when it is merely noise</p>
<p>The key steps in applying statistical surveillance are as follows:</p>
<ol style="list-style-type: decimal">
<li><p>Collecting and standardizing measurements of the outcome variable</p></li>
<li><p>Developing a statistical model to predict the outcome variable</p></li>
<li><p>Using the statistical model to predict the outcome variable in a given region or time period.</p></li>
<li><p>Applying an alarm function to compare the actual outcome with the predictions, and determine the likelihood of the actual outcome happening by chance given the predictions.</p></li>
<li><p>Repeating this process continually as new data is collected.</p></li>
</ol>
<p>The <code>statsurv</code> package is designed to help with every aspect of this process, with a particular emphasis on helping design and evaluate new statistical surveillance systems. It’s perfectly possible that you’ll use <code>statsurv</code> when you’re designing your surveillance system, but decide that it doesn’t make sense to use the package when you actually implement the system.</p>
</div>
<div id="installation" class="section level2">
<h2>Installation</h2>
<p>The <code>statsurv</code> package currently lives on GitHub, at <a href="https://github.com/CO-TEEO/statsurv" class="uri">https://github.com/CO-TEEO/statsurv</a>. Because it is not currently on CRAN, installation is slightly more involved than for a typical R package. The easiest way to install it is to run the commands:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;remotes&quot;</span>) </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;CO-TEEO/statsurv&quot;</span>)</span></code></pre></div>
<p>in RStudio.</p>
</div>
<div id="spacetime-data" class="section level2">
<h2>Spacetime data</h2>
<p>The <code>statsurv</code> package has a very simple way of representing data in a series of spatial areas of time. Spacetime data is stored in a data frame that contains the columns <code>id_space</code> and <code>id_time</code>. The entries in each of these columns must be a set of consecutive integers. The column <code>id_time</code> identifies the time point associated with each row of the data frame, with lower numbers being earlier and higher numbers being later. The column <code>id_space</code> identifies the spatial location or area associated with each row. The specific values of <code>id_space</code> are not assumed to have any meaning or order beyond identification.</p>
<p>If you’re even unsure about whether you’re data is correctly formatted for <code>statsurv</code>, you can call the function <code>validate_spacetime_data</code>, which will give an error if the data frame does not follow the spacetime data conventions.</p>
<p>For more information about formatting data frames to follow these conventions, see the <a href="spacetime_data.html">spacetime data vignette</a></p>
</div>
<div id="using-the-statsurv-package" class="section level2">
<h2>Using the <code>statsurv</code> package</h2>
<p>As an example of how to use the <code>statsurv</code> package, we’re going to use the a data set of brain cancer cases in New Mexico. This dataset was studied by Kulldorff in developing SaTScan, who identified a potential cluster of cases in two counties between 1986 and 1989.</p>
<p>Before we start performing surveillance, we need to load the data. The populations and case counts, as well as the county boundaries, are included as datasets in the <code>statsurv</code> package. The data in the package already comes with a baseline estimate, but we’re going to remove that column and generate our own.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scanstatistics)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom.mixed)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tibble)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;NM_county_sf&quot;</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;NM_data&quot;</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>NM_data <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(NM_data) <span class="sc">%&gt;%</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>baseline_est) </span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>NM_data</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 608 x 6</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    id_time id_space  year county     population count</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;      &lt;dbl&gt;    &lt;dbl&gt; &lt;int&gt; &lt;fct&gt;           &lt;int&gt; &lt;int&gt;</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1       1        1  1973 bernalillo     353813    16</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2       2        1  1974 bernalillo     357520    16</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3       3        1  1975 bernalillo     368166    16</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4       4        1  1976 bernalillo     378483    16</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5       5        1  1977 bernalillo     388471    15</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6       6        1  1978 bernalillo     398130    18</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7       7        1  1979 bernalillo     407460    19</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8       8        1  1980 bernalillo     416461    22</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9       9        1  1981 bernalillo     425133    21</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10      10        1  1982 bernalillo     433476    21</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ... with 598 more rows</span></span></code></pre></div>
<p>In this case, the data is already provided to us at the county level. If instead we had individual case locations, we’d have to first aggregate them to the year and county level.</p>
<div id="developing-a-model" class="section level4">
<h4>Developing a model</h4>
<p>Our first step in the analysis is to develop a model to predict the number of cases in each county in each year. Our model is going to be used to generate estimates of the expected number of cases in the absense of any clusters, so we don’t want to include the potential cluster when fitting our model. We’ll make 2 data sets: one with data through 1985 to used to fit the model, and one with data through 1989 to generate predictions. We can use the <code>prepare_training_data</code> to generate the first data set.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>prediction_data <span class="ot">&lt;-</span> NM_data <span class="sc">%&gt;%</span> </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">&lt;=</span> <span class="dv">1989</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>training_data <span class="ot">&lt;-</span> <span class="fu">prepare_training_data</span>(prediction_data,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">outcome_cols =</span> count, </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">split_id =</span> <span class="dv">14</span>, </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">prep_strategy =</span> <span class="st">&quot;truncate&quot;</span>)</span></code></pre></div>
<p>Now that we have our data sets, we can now fit a model. Let’s start with a fairly simple model, where the number of cases depends on the year, with an offset for the log population of the county.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(count <span class="sc">~</span> <span class="fu">I</span>(year <span class="sc">-</span> <span class="dv">1985</span>),</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">&quot;log&quot;</span>),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">offset =</span> <span class="fu">log</span>(population),</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> training_data)</span></code></pre></div>
<p>Then, to generate predictions of the number of cases, we can use the <code>extract_yhat</code> function from <code>statsurv</code>. This will add a column <code>.fitted</code> to our data frame containing the model estimates for each location.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>aug_data <span class="ot">&lt;-</span> <span class="fu">extract_yhat</span>(mod, prediction_data)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(aug_data<span class="sc">$</span>count, aug_data<span class="sc">$</span>.fitted, <span class="at">xlab =</span> <span class="st">&quot;Observed Counts&quot;</span>, <span class="at">ylab =</span> <span class="st">&quot;Model Predictions&quot;</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>, <span class="at">col =</span> <span class="st">&quot;blue&quot;</span>)</span></code></pre></div>
<p><img src="data:image/png;base64,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" /><!-- --></p>
<p>Those model predictions look OK. But maybe they’d be better if we added a random effect for the county?</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>mod2 <span class="ot">&lt;-</span> <span class="fu">glmer</span>(count <span class="sc">~</span> <span class="fu">I</span>(year <span class="sc">-</span> <span class="dv">1985</span>) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> county) <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(population)),</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">&quot;log&quot;</span>),</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> training_data)</span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>aug_data2 <span class="ot">&lt;-</span> <span class="fu">extract_yhat</span>(mod2, prediction_data)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(aug_data2<span class="sc">$</span>count, aug_data2<span class="sc">$</span>.fitted, <span class="at">xlab =</span> <span class="st">&quot;Observed Counts&quot;</span>, <span class="at">ylab =</span> <span class="st">&quot;Model Predictions&quot;</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>, <span class="at">col =</span> <span class="st">&quot;blue&quot;</span>)</span></code></pre></div>
<p><img src="data:image/png;base64,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" /><!-- --></p>
<p>That looks a bit better. Let’s use the results from that model and see if we can identify any clusters.</p>
<p>To identify clusters, we’re going to use the expectation-based poisson scan statistic. To do this, we’ll use the function <code>scan_eb_poisson2</code>. This function calls <code>scan_eb_poisson</code> from the <code>scanstatistics</code> package, but takes inputs in a more convenient form.</p>
<p>To call this function, we need a single spacetime data frame containing the observed cases and baseline estimates for each location, and a set of <em>zones</em> that we want to scan over. For <code>statsurv</code> and <code>scanstatistics</code>, each zone is a set of 1 or more spatial locations.</p>
<p>We can construct the zones we want to investigate from our spatial setup using the <code>create_zones</code> function. The function takes an <code>sf</code> object and construct zones using a k-nearest neighbors approach. For each location, there will be a zone containing the location itself, a zone containing the location and its nearest neighbor, a zone containing the location and its two nearest-neighbors, up to the maximum size.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>zones <span class="ot">&lt;-</span> <span class="fu">create_zones</span>(NM_county_sf, <span class="at">max_k =</span> <span class="dv">10</span>, <span class="at">min_k =</span> <span class="dv">1</span>)</span></code></pre></div>
<p>Then we can call <code>scan_eb_poisson2</code>. We have to pass a valid spacetime data object to the function, because the function needs to know the spatial location and time period associated with each row. <code>scan_eb_poisson2</code> also uses <em>tidy-evaluation</em>, which means that we can specify the columns containing the observed cases and baseline estimates using bare words, not quoted strings, like we would for <code>dplyr::select</code> or <code>dplyr::mutate</code>. <!--- Note here about what we're actually using? ---></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>scan_res <span class="ot">&lt;-</span> <span class="fu">scan_eb_poisson2</span>(aug_data2, <span class="at">outcome_col =</span> count, zones, </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>                             <span class="at">baseline_col =</span> .fitted, <span class="at">n_mcsim =</span> <span class="dv">99</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>scan_res</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Data distribution:                Poisson</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Type of scan statistic:           expectation-based</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Setting:                          univariate</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Number of locations considered:   32</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Maximum duration considered:      17</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Number of spatial zones:          288</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Number of Monte Carlo replicates: 99</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Monte Carlo P-value:              0.02</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Gumbel P-value:                   NULL</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Most likely event duration:       4</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ID of locations in MLC:           15, 26</span></span></code></pre></div>
<p>We see that the most likely cluster covers 4 years, in locations 15 and 26. We can look up which counties those are:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>NM_county_sf <span class="sc">%&gt;%</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(id_space <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">15</span>, <span class="dv">26</span>))</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Simple feature collection with 2 features and 2 fields</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Dimension:     XY</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Bounding box:  xmin: 371834.6 ymin: 3877849 xmax: 435402.4 ymax: 3984704</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; CRS:           +proj=utm +zone=13</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   id_space    county                       geometry</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1       15 losalamos POLYGON ((373586 3965813, 3...</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2       26   santafe POLYGON ((394170.5 3965524,...</span></span></code></pre></div>
<p>Los Alamos and Santa Fe counties, which are the same counties identified by Kulldorff, 1988.</p>
</div>
</div>
<div id="evaluating-statistical-surveillance-methods" class="section level2">
<h2>Evaluating statistical surveillance methods</h2>
<p>While it’s definitely a good sign that our method identified the same potential cluster as Kulldorff and <code>scanstatistics</code>, that isn’t the only thing we care about. Statistical surveillance techniques are usually used <em>prospectively</em>, meaning that they’re typically used repeatedly as new data is collected. When evaluating a statistical surveillance system, we want to understand how quickly the can detect a true cluster after it starts, and how likely it is to give us false alarms. <code>statsurv</code> has a number of functions to help mimic the experience of running a surveillance system every year as new data is collected.</p>
<div id="performing-surveillance-repeatedly" class="section level4">
<h4>Performing surveillance repeatedly</h4>
<p>The first step in evaluating a surveillance system is to figure out what data would be present each time we run the model. We can use the <code>window_idtime</code> function in the package to do this. We give the minimum number of data points we need to train a model on, and the number of data points we want to generate predictions for, and <code>window_idtime</code> will give us the data available for the model every time we run it.</p>
<p>For this example, we’re going to require a minimum of 7 years of data to fit the model on, and for every year, we’re going to generate predictions for 3 years.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>windowed_data <span class="ot">&lt;-</span> <span class="fu">window_idtime</span>(NM_data, <span class="at">min_train =</span> <span class="dv">7</span>, <span class="at">max_train =</span> <span class="cn">Inf</span>, <span class="at">n_predict =</span> <span class="dv">3</span>,</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">step =</span> <span class="dv">1</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>windowed_data</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 10 x 4</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    window_time_id window_space_id split_id curr_data         </span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;             &lt;dbl&gt; &lt;list&gt;             &lt;dbl&gt; &lt;list&gt;            </span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1             10 &lt;dbl [32]&gt;             8 &lt;tibble [320 x 6]&gt;</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2             11 &lt;dbl [32]&gt;             9 &lt;tibble [352 x 6]&gt;</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3             12 &lt;dbl [32]&gt;            10 &lt;tibble [384 x 6]&gt;</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4             13 &lt;dbl [32]&gt;            11 &lt;tibble [416 x 6]&gt;</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5             14 &lt;dbl [32]&gt;            12 &lt;tibble [448 x 6]&gt;</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6             15 &lt;dbl [32]&gt;            13 &lt;tibble [480 x 6]&gt;</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7             16 &lt;dbl [32]&gt;            14 &lt;tibble [512 x 6]&gt;</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8             17 &lt;dbl [32]&gt;            15 &lt;tibble [544 x 6]&gt;</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9             18 &lt;dbl [32]&gt;            16 &lt;tibble [576 x 6]&gt;</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10             19 &lt;dbl [32]&gt;            17 &lt;tibble [608 x 6]&gt;</span></span></code></pre></div>
<p><code>window_idtime</code> gives back a <em>nested data frame</em>, or a data frame where one or more of the columns is a list of data frames. The tidyverse website has articles about <a href="https://tidyr.tidyverse.org/articles/nest.html">nested data frames</a> and <a href="https://dplyr.tidyverse.org/articles/rowwise.html">list-columns in data frames</a> if you want more information about these concepts.</p>
<p>Nested data frames are a great way of keeping track of sets of data, but they mean that your data frames now have <em>list-columns</em> in them, which makes working with them a little more complicated. Typically, when you use a function in <code>mutate</code>, the whole column gets passed to the function at once. That doesn’t usually work with list-columns - you fit a model on some data by passing it a data frame, not a list of data frames.</p>
<p>If you’re using <code>dplyr</code> and your data frame has list-columns, you’ll typically want to first use <code>rowwise</code>, so that each row in your data frame is treated independently, before you use <code>mutate</code> or other verbs that create or modify columns. And if you create new columns with interesting things in them, like data frames or model fits, you’ll need to remember to wrap the results in a list.</p>
<p>So here’s how we’d prepare our training data and fit a model for each time point using functions from `dplyr:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>windowed_data <span class="sc">%&gt;%</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">training_data =</span> <span class="fu">list</span>(<span class="fu">prepare_training_data</span>(curr_data,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">outcome_cols =</span> count,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">split_id =</span> split_id,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">prep_strategy =</span> <span class="st">&quot;truncate&quot;</span>)),</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">mod =</span> <span class="fu">list</span>(<span class="fu">glmer</span>(count <span class="sc">~</span> <span class="fu">I</span>(year <span class="sc">-</span> <span class="dv">1985</span>) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> county) <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(population)),</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>                       <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">&quot;log&quot;</span>),</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> training_data)))</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 10 x 6</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # Rowwise: </span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    window_time_id window_space_id split_id curr_data     training_data   mod    </span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;             &lt;dbl&gt; &lt;list&gt;             &lt;dbl&gt; &lt;list&gt;        &lt;list&gt;          &lt;list&gt; </span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1             10 &lt;dbl [32]&gt;             8 &lt;tibble [320~ &lt;tibble [224 x~ &lt;glmer~</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2             11 &lt;dbl [32]&gt;             9 &lt;tibble [352~ &lt;tibble [256 x~ &lt;glmer~</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3             12 &lt;dbl [32]&gt;            10 &lt;tibble [384~ &lt;tibble [288 x~ &lt;glmer~</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4             13 &lt;dbl [32]&gt;            11 &lt;tibble [416~ &lt;tibble [320 x~ &lt;glmer~</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5             14 &lt;dbl [32]&gt;            12 &lt;tibble [448~ &lt;tibble [352 x~ &lt;glmer~</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6             15 &lt;dbl [32]&gt;            13 &lt;tibble [480~ &lt;tibble [384 x~ &lt;glmer~</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7             16 &lt;dbl [32]&gt;            14 &lt;tibble [512~ &lt;tibble [416 x~ &lt;glmer~</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8             17 &lt;dbl [32]&gt;            15 &lt;tibble [544~ &lt;tibble [448 x~ &lt;glmer~</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9             18 &lt;dbl [32]&gt;            16 &lt;tibble [576~ &lt;tibble [480 x~ &lt;glmer~</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10             19 &lt;dbl [32]&gt;            17 &lt;tibble [608~ &lt;tibble [512 x~ &lt;glmer~</span></span></code></pre></div>
<p>That works, but it’s a little clunky. <code>statsurv</code> provides a single function, <code>rowmute</code>, that’s supposed to remove a lot of the annoyance of working with list columns in data frames. <code>rowmute</code> is a version of <code>mutate</code> that always works one row at a time. It’s name is a portmanteau of <code>rowwise</code> and <code>mutate</code>, which might help you remember what it’s for.</p>
<p>Here’s how we’d do the same thing using <code>rowmute</code>. It’s only one function call instead of 2, and we don’t have to remember to return a list. It should just work, but if you find a situation where it doesn’t, you can always replace it with <code>rowwise</code> and <code>mutate</code>.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>model_fits <span class="ot">&lt;-</span> windowed_data <span class="sc">%&gt;%</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowmute</span>(<span class="at">training_data =</span> <span class="fu">prepare_training_data</span>(curr_data, </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">outcome_col =</span> count,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">split_id =</span> split_id, </span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">prep_strategy =</span> <span class="st">&quot;truncate&quot;</span>),</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">mod =</span>  <span class="fu">glmer</span>(count <span class="sc">~</span> <span class="fu">I</span>(year <span class="sc">-</span> <span class="dv">1985</span>) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> county) <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(population)),</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>                       <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">&quot;log&quot;</span>),</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> training_data))</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>model_fits</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 10 x 6</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    window_time_id window_space_id split_id curr_data     training_data   mod    </span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;             &lt;dbl&gt; &lt;list&gt;             &lt;dbl&gt; &lt;list&gt;        &lt;list&gt;          &lt;list&gt; </span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1             10 &lt;dbl [32]&gt;             8 &lt;tibble [320~ &lt;tibble [224 x~ &lt;glmer~</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2             11 &lt;dbl [32]&gt;             9 &lt;tibble [352~ &lt;tibble [256 x~ &lt;glmer~</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3             12 &lt;dbl [32]&gt;            10 &lt;tibble [384~ &lt;tibble [288 x~ &lt;glmer~</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4             13 &lt;dbl [32]&gt;            11 &lt;tibble [416~ &lt;tibble [320 x~ &lt;glmer~</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5             14 &lt;dbl [32]&gt;            12 &lt;tibble [448~ &lt;tibble [352 x~ &lt;glmer~</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6             15 &lt;dbl [32]&gt;            13 &lt;tibble [480~ &lt;tibble [384 x~ &lt;glmer~</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7             16 &lt;dbl [32]&gt;            14 &lt;tibble [512~ &lt;tibble [416 x~ &lt;glmer~</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8             17 &lt;dbl [32]&gt;            15 &lt;tibble [544~ &lt;tibble [448 x~ &lt;glmer~</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9             18 &lt;dbl [32]&gt;            16 &lt;tibble [576~ &lt;tibble [480 x~ &lt;glmer~</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10             19 &lt;dbl [32]&gt;            17 &lt;tibble [608~ &lt;tibble [512 x~ &lt;glmer~</span></span></code></pre></div>
<p>Then we can use <code>rowmute</code> again to extract the model predictions</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>model_predictions <span class="ot">&lt;-</span> model_fits <span class="sc">%&gt;%</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowmute</span>(<span class="at">aug_data =</span> <span class="fu">extract_yhat</span>(mod, curr_data))</span></code></pre></div>
<p>This adds the column <code>aug_data</code> to our giant data frame of everything, containing the model predictions at every time point.</p>
<p>Finally, we can use this data to calculate a scan statistic at every point.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>scan_results <span class="ot">&lt;-</span> model_predictions <span class="sc">%&gt;%</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowmute</span>(<span class="at">scan_res =</span> <span class="fu">scan_eb_poisson2</span>(aug_data, <span class="at">outcome_col =</span> count, zones, </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>                             <span class="at">baseline_col =</span> .fitted, <span class="at">n_mcsim =</span> <span class="dv">99</span>))</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>scan_results</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 10 x 8</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    window_time_id window_space_id split_id curr_data     training_data   mod    </span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;             &lt;dbl&gt; &lt;list&gt;             &lt;dbl&gt; &lt;list&gt;        &lt;list&gt;          &lt;list&gt; </span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1             10 &lt;dbl [32]&gt;             8 &lt;tibble [320~ &lt;tibble [224 x~ &lt;glmer~</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2             11 &lt;dbl [32]&gt;             9 &lt;tibble [352~ &lt;tibble [256 x~ &lt;glmer~</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3             12 &lt;dbl [32]&gt;            10 &lt;tibble [384~ &lt;tibble [288 x~ &lt;glmer~</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4             13 &lt;dbl [32]&gt;            11 &lt;tibble [416~ &lt;tibble [320 x~ &lt;glmer~</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5             14 &lt;dbl [32]&gt;            12 &lt;tibble [448~ &lt;tibble [352 x~ &lt;glmer~</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6             15 &lt;dbl [32]&gt;            13 &lt;tibble [480~ &lt;tibble [384 x~ &lt;glmer~</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7             16 &lt;dbl [32]&gt;            14 &lt;tibble [512~ &lt;tibble [416 x~ &lt;glmer~</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8             17 &lt;dbl [32]&gt;            15 &lt;tibble [544~ &lt;tibble [448 x~ &lt;glmer~</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9             18 &lt;dbl [32]&gt;            16 &lt;tibble [576~ &lt;tibble [480 x~ &lt;glmer~</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10             19 &lt;dbl [32]&gt;            17 &lt;tibble [608~ &lt;tibble [512 x~ &lt;glmer~</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ... with 2 more variables: aug_data &lt;list&gt;, scan_res &lt;list&gt;</span></span></code></pre></div>
<p>And now we have our results! A list of the scan statistic at every point in time. Once we have the results, there’s a couple things we can do with them.</p>
<p>First, we can extract information about the top cluster at every time point, using the <code>report_top_clusters</code> function.We’ll then <code>unnest</code> the resulting data frame to get the information out as a single data frame.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>top_clusters_over_time <span class="ot">&lt;-</span> scan_results <span class="sc">%&gt;%</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowmute</span>(<span class="at">top_cluster =</span> <span class="fu">report_top_clusters</span>(scan_res, score, <span class="at">max_reported =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(window_time_id, top_cluster) <span class="sc">%&gt;%</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(top_cluster)</span></code></pre></div>
<p>Let’s add back in the information about the year and the counties affected:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>years <span class="ot">&lt;-</span> <span class="fu">distinct</span>(NM_data[, <span class="fu">c</span>(<span class="st">&quot;id_time&quot;</span>, <span class="st">&quot;year&quot;</span>)])</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>top_clusters_over_time <span class="ot">&lt;-</span> <span class="fu">left_join</span>(top_clusters_over_time, years, </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;window_time_id&quot;</span> <span class="ot">=</span> <span class="st">&quot;id_time&quot;</span>)) </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>top_clusters_over_time <span class="sc">%&gt;%</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowmute</span>(<span class="at">counties =</span> NM_county_sf<span class="sc">$</span>county[zones[[zone]]]) <span class="sc">%&gt;%</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(year, duration, score, mc_pvalue, counties) <span class="sc">%&gt;%</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest_wider</span>(counties)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 10 x 14</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     year duration score mc_pvalue ...1       ...2  ...3  ...4  ...5  ...6  ...7 </span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    &lt;int&gt;    &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1  1982        1  5.21      0.19 curry      roos~ &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; </span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2  1983        2  5.42      0.16 curry      roos~ &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; </span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3  1984        5  5.57      0.17 bernalillo losa~ mora  rioa~ sand~ sanm~ sant~</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4  1985        1  6.82      0.06 bernalillo catr~ dona~ linc~ sand~ sier~ soco~</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5  1986        2  7.53      0.04 bernalillo catr~ dona~ linc~ sand~ sant~ sier~</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6  1987        2 10.3       0.01 colfax     guad~ hard~ losa~ mora  sanm~ sant~</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7  1988        3  9.68      0.01 colfax     deba~ guad~ hard~ losa~ mora  quay </span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8  1989        4  7.87      0.01 losalamos  sant~ &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; </span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9  1990        5  5.66      0.15 colfax     guad~ hard~ losa~ mora  quay  sanm~</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10  1991       17  3.78      0.55 sierra     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; </span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ... with 3 more variables: ...8 &lt;chr&gt;, ...9 &lt;chr&gt;, ...10 &lt;chr&gt;</span></span></code></pre></div>
<p>Interestingly, we see that in addition to the cluster identified in 1989, several other, stronger clusters were detected in previous years. This includes large clusters in 1987 and 1988, and a cluster in 1985 that is nearly as strong as the one in 1989, but includes neither of the counties identified in 1989. This suggests that the potential cluster in 1989 occurred by chance, not withstanding the low p-values calculated by the alarm function. That agrees with the findings of Kuldorff, 1998, who also concluded that the cluster detected in 1986-1989 most likely occured by chance. As a result, we should probably go back and re-examine our model, and see if it’s adequately capturing the trends in the data over time.</p>
<p>We could also look at trends in the cluster over time. We’re interested in the rates in Los Alamos and Sante Fe counties, which corresponds to zone number #132. We can use <code>report_top_clusters</code> to do this as well - we’ll first extract information about all the clusters, and then filter to the ones for zone #132.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>trends_in_zone132 <span class="ot">&lt;-</span> scan_results <span class="sc">%&gt;%</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowmute</span>(<span class="at">all_clusters =</span> <span class="fu">report_top_clusters</span>(scan_res, score, <span class="at">max_reported =</span> <span class="cn">Inf</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(window_time_id, all_clusters) <span class="sc">%&gt;%</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(all_clusters) <span class="sc">%&gt;%</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(zone <span class="sc">==</span> <span class="dv">132</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(years, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;window_time_id&quot;</span> <span class="ot">=</span> <span class="st">&quot;id_time&quot;</span>)) </span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(trends_in_zone132, <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> mc_pvalue)) <span class="sc">+</span> </span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span></code></pre></div>
<p><img src="data:image/png;base64,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" /><!-- --></p>
</div>
<div id="refining-our-approach" class="section level3">
<h3>Refining our approach</h3>
<p>One of the strength of <code>statsurv</code> is the ability to swap out bits and pieces of your analysis while keeping the rest intact. As a simple example, we can switch from using a poisson-based alarm function, to using a negative binomial-based alarm function:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the negative binomial scan function instead of the expectation-based poisson</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>nb_scan_results <span class="ot">&lt;-</span> model_predictions <span class="sc">%&gt;%</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowmute</span>(<span class="at">scan_res =</span> <span class="fu">scan_eb_negbin2</span>(aug_data, <span class="at">outcome_col =</span> count, zones, </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">baseline_col =</span> .fitted, <span class="at">n_mcsim =</span> <span class="dv">99</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">theta_col =</span> <span class="dv">1</span>))</span></code></pre></div>
<p>We can also use a CUSUM alarm function, instead of a scan-type alarm function:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>cusum_results <span class="ot">&lt;-</span> model_predictions <span class="sc">%&gt;%</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowmute</span>(<span class="at">cumusm_res =</span> <span class="fu">parallel_cusum_poisson2</span>(aug_data, count, .fitted))</span></code></pre></div>
<p>We can also swap out how we’re preforming our modeling. <code>lm</code>, <code>glm</code>, <code>INLA</code>, <code>lme4</code>, <code>ARIMA</code>, and <code>INLA</code> will all work without modification, as will any other model that has an <code>augment</code> function.</p>
<p>Let’s fit our data using an INLA model:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(INLA)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>model_fits <span class="ot">&lt;-</span> windowed_data <span class="sc">%&gt;%</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowmute</span>(<span class="at">training_data =</span> <span class="fu">prepare_training_data</span>(curr_data, </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">outcome_col =</span> count,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">split_id =</span> split_id, </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">prep_strategy =</span> <span class="st">&quot;NA&quot;</span>),</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">mod =</span>  <span class="fu">inla</span>(count <span class="sc">~</span> <span class="fu">I</span>(year <span class="sc">-</span> <span class="dv">1985</span>) <span class="sc">+</span> <span class="fu">f</span>(county, <span class="at">model =</span> <span class="st">&quot;iid&quot;</span>),</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>                      <span class="at">family =</span> <span class="st">&quot;poisson&quot;</span>,</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> training_data,</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>                      <span class="at">offset =</span> <span class="fu">log</span>(population),</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>                      <span class="at">control.predictor=</span><span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>)))</span></code></pre></div>
<p>Note that we have to use <code>prep_strategy = &quot;NA&quot;</code> and <code>control.predictor=list(compute = TRUE)</code> in order to be able to extract accurate predictions from the INLA model.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>model_fits <span class="sc">%&gt;%</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowmute</span>(<span class="at">aug_data =</span> <span class="fu">extract_yhat</span>(mod, curr_data))</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 10 x 7</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    window_time_id window_space_id split_id curr_data      training_data    mod  </span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;             &lt;dbl&gt; &lt;list&gt;             &lt;dbl&gt; &lt;list&gt;         &lt;list&gt;           &lt;lis&gt;</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1             10 &lt;dbl [32]&gt;             8 &lt;tibble [320 ~ &lt;tibble [320 x ~ &lt;inl~</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2             11 &lt;dbl [32]&gt;             9 &lt;tibble [352 ~ &lt;tibble [352 x ~ &lt;inl~</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3             12 &lt;dbl [32]&gt;            10 &lt;tibble [384 ~ &lt;tibble [384 x ~ &lt;inl~</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4             13 &lt;dbl [32]&gt;            11 &lt;tibble [416 ~ &lt;tibble [416 x ~ &lt;inl~</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5             14 &lt;dbl [32]&gt;            12 &lt;tibble [448 ~ &lt;tibble [448 x ~ &lt;inl~</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6             15 &lt;dbl [32]&gt;            13 &lt;tibble [480 ~ &lt;tibble [480 x ~ &lt;inl~</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7             16 &lt;dbl [32]&gt;            14 &lt;tibble [512 ~ &lt;tibble [512 x ~ &lt;inl~</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8             17 &lt;dbl [32]&gt;            15 &lt;tibble [544 ~ &lt;tibble [544 x ~ &lt;inl~</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9             18 &lt;dbl [32]&gt;            16 &lt;tibble [576 ~ &lt;tibble [576 x ~ &lt;inl~</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10             19 &lt;dbl [32]&gt;            17 &lt;tibble [608 ~ &lt;tibble [608 x ~ &lt;inl~</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ... with 1 more variable: aug_data &lt;list&gt;</span></span></code></pre></div>
<p>The ability to swap out different parts of a surveillance system without having to change other parts makes it easier to improve and refine your surveillance system as you are developing it.</p>
</div>
</div>
<div id="other-features" class="section level2">
<h2>Other features</h2>
<p>There are a number of other features inside the <code>statsurv</code> package that might be useful depending on what you’re trying to do. Here are a few of them:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Applying the same model to different spatial locations</strong>: Some models, such as many ARIMA models, can only handle a single spatial location at a time. The <code>window_id_time</code> function can include each spatial location in a separate window. Then you can fit a model on each window, and then combine all the locations together using the <code>collapse_all</code> function.</p></li>
<li><p><strong>Friendlier ARIMA models</strong>: ARIMA (Autoregressive Integrated Moving Average) models are widely used to analyze time series. There are a number of ways to fit ARIMA models in R, but most of them use very different arguments and specifications than other types of models, such <code>lm</code> or <code>glm</code> models. <code>arima_tidy</code> is a function that allows use to fit ARIMA models with covariates using formulas, instead of passing in a matrix of regressors.</p></li>
<li><p><strong>Surveillance Residuals</strong>: In statistical surveillance, “surveillance residuals” are defined as the difference between observed data for a new time period and the predictions from a model fit using previous time periods. The key difference from ordinary model residuals is that surveillance residuals are never calculated for data points used to fit the model. In theory, examining surveillance residuals should allow statistical methods to detect outbreaks or clusters more rapidly, since the model used to predict baseline estimates is not affected by any current outbreaks. In practice, it is still an open question whether using surveillance residuals over ordinary residuals provides any appreciable benefit. <code>calculate_surveillance_residuals</code> takes a set of data frames and combines the most recent time period or time periods from each one. If the data frames contain the estimates from sequentially fitting a model, then the new set of data frames contains the surveillance residuals from the series of model fits.</p></li>
<li><p><strong>Secondary Clusters</strong>: In addition to reporting the most likely cluster in the study area, scan statistics can be used to identify any independent secondary clusters that exist. In order to identify any secondary clusters, we must remove information about clusters that are almost identical to the primary cluster. Calling the function <code>remove_overlapping_clusters</code> before running <code>report_top_clusters</code> will identify these independent secondary clusters.</p></li>
</ol>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
