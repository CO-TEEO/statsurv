<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="statsurv">
<title>An introduction to `statsurv` • statsurv</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="An introduction to `statsurv`">
<meta property="og:description" content="statsurv">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">statsurv</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/spacetime_data.html">Spacetime Data in statsurv</a>
    <a class="dropdown-item" href="../articles/statsurv_overview.html">An introduction to `statsurv`</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/CO-TEEO/statsurv/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>An introduction to `statsurv`</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/CO-TEEO/statsurv/blob/HEAD/vignettes/statsurv_overview.Rmd" class="external-link"><code>vignettes/statsurv_overview.Rmd</code></a></small>
      <div class="d-none name"><code>statsurv_overview.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/CO-TEEO/statsurv" class="external-link">statsurv</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>Statistical surveillance is any sort of systematic, ongoing analysis
aimed at detecting changes in outcomes as they occur. This process
requires developing a model to predict the outcome of interest, and then
systematically examining the measured outcomes as they occur and
determining when the observed outcomes no longer match the predicted
outcomes. If the amount of data reported is large or if there is
significant natural variability in the rate of case events, statistical
techniques can be extremely helpful in determining when a change in the
number of events is important, and when it is merely noise</p>
<p>The key steps in applying statistical surveillance are as
follows:</p>
<ol style="list-style-type: decimal">
<li><p>Collecting and standardizing measurements of the outcome
variable</p></li>
<li><p>Developing a statistical model to predict the outcome
variable</p></li>
<li><p>Using the statistical model to predict the outcome variable in a
given region or time period.</p></li>
<li><p>Applying an alarm function to compare the actual outcome with the
predictions, and determine the likelihood of the actual outcome
happening by chance given the predictions.</p></li>
<li><p>Repeating this process continually as new data is
collected.</p></li>
</ol>
<p>The <code>statsurv</code> package is designed to help with every
aspect of this process, with a particular emphasis on helping design and
evaluate new statistical surveillance systems. It’s perfectly possible
that you’ll use <code>statsurv</code> when you’re designing your
surveillance system, but decide that it doesn’t make sense to use the
package when you actually implement the system.</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>The <code>statsurv</code> package currently lives on GitHub, at <a href="https://github.com/CO-TEEO/statsurv" class="external-link uri">https://github.com/CO-TEEO/statsurv</a>. Because it is not
currently on CRAN, installation is slightly more involved than for a
typical R package. The easiest way to install it is to run the
commands:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"remotes"</span><span class="op">)</span> </span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"cran/reliaR"</span><span class="op">)</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"BenjaK/scanstatistics"</span><span class="op">)</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"CO-TEEO/statsurv"</span><span class="op">)</span></span></code></pre></div>
<p>in RStudio.</p>
</div>
<div class="section level2">
<h2 id="spacetime-data">Spacetime data<a class="anchor" aria-label="anchor" href="#spacetime-data"></a>
</h2>
<p>The <code>statsurv</code> package has a very simple way of
representing data in a series of spatial areas of time. Spacetime data
is stored in a data frame that contains the columns
<code>id_space</code> and <code>id_time</code>. The entries in each of
these columns must be a set of consecutive integers. The column
<code>id_time</code> identifies the time point associated with each row
of the data frame, with lower numbers being earlier and higher numbers
being later. The column <code>id_space</code> identifies the spatial
location or area associated with each row. The specific values of
<code>id_space</code> are not assumed to have any meaning or order
beyond identification.</p>
<p>If you’re even unsure about whether you’re data is correctly
formatted for <code>statsurv</code>, you can call the function
<code>validate_spacetime_data</code>, which will give an error if the
data frame does not follow the spacetime data conventions.</p>
<p>For more information about formatting data frames to follow these
conventions, see the <a href="spacetime_data.html">spacetime data
vignette</a></p>
</div>
<div class="section level2">
<h2 id="using-the-statsurv-package">Using the <code>statsurv</code> package<a class="anchor" aria-label="anchor" href="#using-the-statsurv-package"></a>
</h2>
<p>As an example of how to use the <code>statsurv</code> package, we’re
going to use the a data set of brain cancer cases in New Mexico. This
dataset was studied by Kulldorff in developing SaTScan, who identified a
potential cluster of cases in two counties between 1986 and 1989.</p>
<p>Before we start performing surveillance, we need to load the data.
The populations and case counts, as well as the county boundaries, are
included as datasets in the <code>statsurv</code> package. The data in
the package already comes with a baseline estimate, but we’re going to
remove that column and generate our own.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/BenjaK/scanstatistics" class="external-link">scanstatistics</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbolker/broom.mixed" class="external-link">broom.mixed</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/" class="external-link">broom</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/" class="external-link">lme4</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"NM_county_sf"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"NM_data"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">NM_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">NM_data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">baseline_est</span><span class="op">)</span> </span>
<span><span class="va">NM_data</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 608 x 6</span></span></span>
<span><span class="co">#&gt;    id_time id_space  year county     population count</span></span>
<span><span class="co">#&gt;      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>       1        1  <span style="text-decoration: underline;">1</span>973 bernalillo     <span style="text-decoration: underline;">353</span>813    16</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>       2        1  <span style="text-decoration: underline;">1</span>974 bernalillo     <span style="text-decoration: underline;">357</span>520    16</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>       3        1  <span style="text-decoration: underline;">1</span>975 bernalillo     <span style="text-decoration: underline;">368</span>166    16</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>       4        1  <span style="text-decoration: underline;">1</span>976 bernalillo     <span style="text-decoration: underline;">378</span>483    16</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>       5        1  <span style="text-decoration: underline;">1</span>977 bernalillo     <span style="text-decoration: underline;">388</span>471    15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>       6        1  <span style="text-decoration: underline;">1</span>978 bernalillo     <span style="text-decoration: underline;">398</span>130    18</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>       7        1  <span style="text-decoration: underline;">1</span>979 bernalillo     <span style="text-decoration: underline;">407</span>460    19</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>       8        1  <span style="text-decoration: underline;">1</span>980 bernalillo     <span style="text-decoration: underline;">416</span>461    22</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>       9        1  <span style="text-decoration: underline;">1</span>981 bernalillo     <span style="text-decoration: underline;">425</span>133    21</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>      10        1  <span style="text-decoration: underline;">1</span>982 bernalillo     <span style="text-decoration: underline;">433</span>476    21</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ... with 598 more rows</span></span></span></code></pre></div>
<p>In this case, the data is already provided to us at the county level.
If instead we had individual case locations, we’d have to first
aggregate them to the year and county level.</p>
<div class="section level4">
<h4 id="developing-a-model">Developing a model<a class="anchor" aria-label="anchor" href="#developing-a-model"></a>
</h4>
<p>Our first step in the analysis is to develop a model to predict the
number of cases in each county in each year. Our model is going to be
used to generate estimates of the expected number of cases in the
absense of any clusters, so we don’t want to include the potential
cluster when fitting our model. We’ll make 2 data sets: one with data
through 1985 to used to fit the model, and one with data through 1989 to
generate predictions. We can use the <code>prepare_training_data</code>
to generate the first data set.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prediction_data</span> <span class="op">&lt;-</span> <span class="va">NM_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">&lt;=</span> <span class="fl">1989</span><span class="op">)</span></span>
<span></span>
<span><span class="va">training_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_training_data.html">prepare_training_data</a></span><span class="op">(</span><span class="va">prediction_data</span>,</span>
<span>                                         outcome_cols <span class="op">=</span> <span class="va">count</span>, </span>
<span>                                         split_id <span class="op">=</span> <span class="fl">14</span>, </span>
<span>                                         prep_strategy <span class="op">=</span> <span class="st">"truncate"</span><span class="op">)</span></span></code></pre></div>
<p>Now that we have our data sets, we can now fit a model. Let’s start
with a fairly simple model, where the number of cases depends on the
year, with an offset for the log population of the county.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">count</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">year</span> <span class="op">-</span> <span class="fl">1985</span><span class="op">)</span>,</span>
<span>           family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>,</span>
<span>           offset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">population</span><span class="op">)</span>,</span>
<span>           data <span class="op">=</span> <span class="va">training_data</span><span class="op">)</span></span></code></pre></div>
<p>Then, to generate predictions of the number of cases, we can use the
<code>extract_yhat</code> function from <code>statsurv</code>. This will
add a column <code>.fitted</code> to our data frame containing the model
estimates for each location.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aug_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_yhat.html">extract_yhat</a></span><span class="op">(</span><span class="va">mod</span>, <span class="va">prediction_data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">aug_data</span><span class="op">$</span><span class="va">count</span>, <span class="va">aug_data</span><span class="op">$</span><span class="va">.fitted</span>, xlab <span class="op">=</span> <span class="st">"Observed Counts"</span>, ylab <span class="op">=</span> <span class="st">"Model Predictions"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">0</span>, b <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="statsurv_overview_files/figure-html/extract-yhat-1.png" width="700"></p>
<p>Those model predictions look OK. But maybe they’d be better if we
added a random effect for the county?</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/glmer.html" class="external-link">glmer</a></span><span class="op">(</span><span class="va">count</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">year</span> <span class="op">-</span> <span class="fl">1985</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">county</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">population</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>,</span>
<span>              data <span class="op">=</span> <span class="va">training_data</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aug_data2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_yhat.html">extract_yhat</a></span><span class="op">(</span><span class="va">mod2</span>, <span class="va">prediction_data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">aug_data2</span><span class="op">$</span><span class="va">count</span>, <span class="va">aug_data2</span><span class="op">$</span><span class="va">.fitted</span>, xlab <span class="op">=</span> <span class="st">"Observed Counts"</span>, ylab <span class="op">=</span> <span class="st">"Model Predictions"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">0</span>, b <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="statsurv_overview_files/figure-html/extract-yhat-2-1.png" width="700"></p>
<p>That looks a bit better. Let’s use the results from that model and
see if we can identify any clusters.</p>
<p>To identify clusters, we’re going to use the expectation-based
poisson scan statistic. To do this, we’ll use the function
<code>scan_eb_poisson2</code>. This function calls
<code>scan_eb_poisson</code> from the <code>scanstatistics</code>
package, but takes inputs in a more convenient form.</p>
<p>To call this function, we need a single spacetime data frame
containing the observed cases and baseline estimates for each location,
and a set of <em>zones</em> that we want to scan over. For
<code>statsurv</code> and <code>scanstatistics</code>, each zone is a
set of 1 or more spatial locations.</p>
<p>We can construct the zones we want to investigate from our spatial
setup using the <code>create_zones</code> function. The function takes
an <code>sf</code> object and construct zones using a k-nearest
neighbors approach. For each location, there will be a zone containing
the location itself, a zone containing the location and its nearest
neighbor, a zone containing the location and its two nearest-neighbors,
up to the maximum size.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">zones</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_zones.html">create_zones</a></span><span class="op">(</span><span class="va">NM_county_sf</span>, max_k <span class="op">=</span> <span class="fl">10</span>, min_k <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>Then we can call <code>scan_eb_poisson2</code>. We have to pass a
valid spacetime data object to the function, because the function needs
to know the spatial location and time period associated with each row.
<code>scan_eb_poisson2</code> also uses <em>tidy-evaluation</em>, which
means that we can specify the columns containing the observed cases and
baseline estimates using bare words, not quoted strings, like we would
for <code><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">dplyr::select</a></code> or <code><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">dplyr::mutate</a></code>.
<!--- Note here about what we're actually using? ---></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scan_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/scan_eb_poisson2.html">scan_eb_poisson2</a></span><span class="op">(</span><span class="va">aug_data2</span>, outcome_col <span class="op">=</span> <span class="va">count</span>, <span class="va">zones</span>, </span>
<span>                             baseline_col <span class="op">=</span> <span class="va">.fitted</span>, n_mcsim <span class="op">=</span> <span class="fl">99</span><span class="op">)</span></span>
<span><span class="va">scan_res</span></span>
<span><span class="co">#&gt; Data distribution:                Poisson</span></span>
<span><span class="co">#&gt; Type of scan statistic:           expectation-based</span></span>
<span><span class="co">#&gt; Setting:                          univariate</span></span>
<span><span class="co">#&gt; Number of locations considered:   32</span></span>
<span><span class="co">#&gt; Maximum duration considered:      17</span></span>
<span><span class="co">#&gt; Number of spatial zones:          288</span></span>
<span><span class="co">#&gt; Number of Monte Carlo replicates: 99</span></span>
<span><span class="co">#&gt; Monte Carlo P-value:              0.01</span></span>
<span><span class="co">#&gt; Gumbel P-value:                   NULL</span></span>
<span><span class="co">#&gt; Most likely event duration:       4</span></span>
<span><span class="co">#&gt; ID of locations in MLC:           15, 26</span></span></code></pre></div>
<p>We see that the most likely cluster covers 4 years, in locations 15
and 26. We can look up which counties those are:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NM_county_sf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">id_space</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">26</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 2 features and 2 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 371834.6 ymin: 3877849 xmax: 435402.4 ymax: 3984704</span></span>
<span><span class="co">#&gt; CRS:           +proj=utm +zone=13</span></span>
<span><span class="co">#&gt;   id_space    county                       geometry</span></span>
<span><span class="co">#&gt; 1       15 losalamos POLYGON ((373586 3965813, 3...</span></span>
<span><span class="co">#&gt; 2       26   santafe POLYGON ((394170.5 3965524,...</span></span></code></pre></div>
<p>Los Alamos and Santa Fe counties, which are the same counties
identified by Kulldorff, 1988.</p>
</div>
</div>
<div class="section level2">
<h2 id="evaluating-statistical-surveillance-methods">Evaluating statistical surveillance methods<a class="anchor" aria-label="anchor" href="#evaluating-statistical-surveillance-methods"></a>
</h2>
<p>While it’s definitely a good sign that our method identified the same
potential cluster as Kulldorff and <code>scanstatistics</code>, that
isn’t the only thing we care about. Statistical surveillance techniques
are usually used <em>prospectively</em>, meaning that they’re typically
used repeatedly as new data is collected. When evaluating a statistical
surveillance system, we want to understand how quickly the can detect a
true cluster after it starts, and how likely it is to give us false
alarms. <code>statsurv</code> has a number of functions to help mimic
the experience of running a surveillance system every year as new data
is collected.</p>
<div class="section level4">
<h4 id="performing-surveillance-repeatedly">Performing surveillance repeatedly<a class="anchor" aria-label="anchor" href="#performing-surveillance-repeatedly"></a>
</h4>
<p>The first step in evaluating a surveillance system is to figure out
what data would be present each time we run the model. We can use the
<code>window_idtime</code> function in the package to do this. We give
the minimum number of data points we need to train a model on, and the
number of data points we want to generate predictions for, and
<code>window_idtime</code> will give us the data available for the model
every time we run it.</p>
<p>For this example, we’re going to require a minimum of 7 years of data
to fit the model on, and for every year, we’re going to generate
predictions for 3 years.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">windowed_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/window_idtime.html">window_idtime</a></span><span class="op">(</span><span class="va">NM_data</span>, min_train <span class="op">=</span> <span class="fl">7</span>, max_train <span class="op">=</span> <span class="cn">Inf</span>, n_predict <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                               step <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">windowed_data</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 x 4</span></span></span>
<span><span class="co">#&gt;    window_time_id window_space_id split_id curr_data         </span></span>
<span><span class="co">#&gt;             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>            </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>             10 <span style="color: #949494;">&lt;dbl [32]&gt;</span>             8 <span style="color: #949494;">&lt;tibble [320 x 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>             11 <span style="color: #949494;">&lt;dbl [32]&gt;</span>             9 <span style="color: #949494;">&lt;tibble [352 x 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>             12 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            10 <span style="color: #949494;">&lt;tibble [384 x 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>             13 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            11 <span style="color: #949494;">&lt;tibble [416 x 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>             14 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            12 <span style="color: #949494;">&lt;tibble [448 x 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>             15 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            13 <span style="color: #949494;">&lt;tibble [480 x 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>             16 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            14 <span style="color: #949494;">&lt;tibble [512 x 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>             17 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            15 <span style="color: #949494;">&lt;tibble [544 x 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>             18 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            16 <span style="color: #949494;">&lt;tibble [576 x 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>             19 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            17 <span style="color: #949494;">&lt;tibble [608 x 6]&gt;</span></span></span></code></pre></div>
<p><code>window_idtime</code> gives back a <em>nested data frame</em>,
or a data frame where one or more of the columns is a list of data
frames. The tidyverse website has articles about <a href="https://tidyr.tidyverse.org/articles/nest.html" class="external-link">nested data
frames</a> and <a href="https://dplyr.tidyverse.org/articles/rowwise.html" class="external-link">list-columns in
data frames</a> if you want more information about these concepts.</p>
<p>Nested data frames are a great way of keeping track of sets of data,
but they mean that your data frames now have <em>list-columns</em> in
them, which makes working with them a little more complicated.
Typically, when you use a function in <code>mutate</code>, the whole
column gets passed to the function at once. That doesn’t usually work
with list-columns - you fit a model on some data by passing it a data
frame, not a list of data frames.</p>
<p>If you’re using <code>dplyr</code> and your data frame has
list-columns, you’ll typically want to first use <code>rowwise</code>,
so that each row in your data frame is treated independently, before you
use <code>mutate</code> or other verbs that create or modify columns.
And if you create new columns with interesting things in them, like data
frames or model fits, you’ll need to remember to wrap the results in a
list.</p>
<p>So here’s how we’d prepare our training data and fit a model for each
time point using functions from `dplyr:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">windowed_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html" class="external-link">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>training_data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/prepare_training_data.html">prepare_training_data</a></span><span class="op">(</span><span class="va">curr_data</span>,</span>
<span>                                                      outcome_cols <span class="op">=</span> <span class="va">count</span>,</span>
<span>                                                      split_id <span class="op">=</span> <span class="va">split_id</span>,</span>
<span>                                                      prep_strategy <span class="op">=</span> <span class="st">"truncate"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         mod <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/glmer.html" class="external-link">glmer</a></span><span class="op">(</span><span class="va">count</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">year</span> <span class="op">-</span> <span class="fl">1985</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">county</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">population</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                       family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>,</span>
<span>                       data <span class="op">=</span> <span class="va">training_data</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 x 6</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Rowwise: </span></span></span>
<span><span class="co">#&gt;    window_time_id window_space_id split_id curr_data training_data mod       </span></span>
<span><span class="co">#&gt;             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>             10 <span style="color: #949494;">&lt;dbl [32]&gt;</span>             8 &lt;tibble&gt;  &lt;tibble&gt;      <span style="color: #949494;">&lt;glmerMod&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>             11 <span style="color: #949494;">&lt;dbl [32]&gt;</span>             9 &lt;tibble&gt;  &lt;tibble&gt;      <span style="color: #949494;">&lt;glmerMod&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>             12 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            10 &lt;tibble&gt;  &lt;tibble&gt;      <span style="color: #949494;">&lt;glmerMod&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>             13 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            11 &lt;tibble&gt;  &lt;tibble&gt;      <span style="color: #949494;">&lt;glmerMod&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>             14 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            12 &lt;tibble&gt;  &lt;tibble&gt;      <span style="color: #949494;">&lt;glmerMod&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>             15 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            13 &lt;tibble&gt;  &lt;tibble&gt;      <span style="color: #949494;">&lt;glmerMod&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>             16 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            14 &lt;tibble&gt;  &lt;tibble&gt;      <span style="color: #949494;">&lt;glmerMod&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>             17 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            15 &lt;tibble&gt;  &lt;tibble&gt;      <span style="color: #949494;">&lt;glmerMod&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>             18 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            16 &lt;tibble&gt;  &lt;tibble&gt;      <span style="color: #949494;">&lt;glmerMod&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>             19 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            17 &lt;tibble&gt;  &lt;tibble&gt;      <span style="color: #949494;">&lt;glmerMod&gt;</span></span></span></code></pre></div>
<p>That works, but it’s a little clunky. <code>statsurv</code> provides
a single function, <code>rowmute</code>, that’s supposed to remove a lot
of the annoyance of working with list columns in data frames.
<code>rowmute</code> is a version of <code>mutate</code> that always
works one row at a time. It’s name is a portmanteau of
<code>rowwise</code> and <code>mutate</code>, which might help you
remember what it’s for.</p>
<p>Here’s how we’d do the same thing using <code>rowmute</code>. It’s
only one function call instead of 2, and we don’t have to remember to
return a list. It should just work, but if you find a situation where it
doesn’t, you can always replace it with <code>rowwise</code> and
<code>mutate</code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_fits</span> <span class="op">&lt;-</span> <span class="va">windowed_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/rowmute.html">rowmute</a></span><span class="op">(</span>training_data <span class="op">=</span> <span class="fu"><a href="../reference/prepare_training_data.html">prepare_training_data</a></span><span class="op">(</span><span class="va">curr_data</span>, </span>
<span>                                                  outcome_col <span class="op">=</span> <span class="va">count</span>,</span>
<span>                                                  split_id <span class="op">=</span> <span class="va">split_id</span>, </span>
<span>                                                  prep_strategy <span class="op">=</span> <span class="st">"truncate"</span><span class="op">)</span>,</span>
<span>          mod <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/glmer.html" class="external-link">glmer</a></span><span class="op">(</span><span class="va">count</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">year</span> <span class="op">-</span> <span class="fl">1985</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">county</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">population</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                       family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>,</span>
<span>                       data <span class="op">=</span> <span class="va">training_data</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_fits</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 x 6</span></span></span>
<span><span class="co">#&gt;    window_time_id window_space_id split_id curr_data training_data mod       </span></span>
<span><span class="co">#&gt;             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>             10 <span style="color: #949494;">&lt;dbl [32]&gt;</span>             8 &lt;tibble&gt;  &lt;tibble&gt;      <span style="color: #949494;">&lt;glmerMod&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>             11 <span style="color: #949494;">&lt;dbl [32]&gt;</span>             9 &lt;tibble&gt;  &lt;tibble&gt;      <span style="color: #949494;">&lt;glmerMod&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>             12 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            10 &lt;tibble&gt;  &lt;tibble&gt;      <span style="color: #949494;">&lt;glmerMod&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>             13 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            11 &lt;tibble&gt;  &lt;tibble&gt;      <span style="color: #949494;">&lt;glmerMod&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>             14 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            12 &lt;tibble&gt;  &lt;tibble&gt;      <span style="color: #949494;">&lt;glmerMod&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>             15 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            13 &lt;tibble&gt;  &lt;tibble&gt;      <span style="color: #949494;">&lt;glmerMod&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>             16 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            14 &lt;tibble&gt;  &lt;tibble&gt;      <span style="color: #949494;">&lt;glmerMod&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>             17 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            15 &lt;tibble&gt;  &lt;tibble&gt;      <span style="color: #949494;">&lt;glmerMod&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>             18 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            16 &lt;tibble&gt;  &lt;tibble&gt;      <span style="color: #949494;">&lt;glmerMod&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>             19 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            17 &lt;tibble&gt;  &lt;tibble&gt;      <span style="color: #949494;">&lt;glmerMod&gt;</span></span></span></code></pre></div>
<p>Then we can use <code>rowmute</code> again to extract the model
predictions</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_predictions</span> <span class="op">&lt;-</span> <span class="va">model_fits</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/rowmute.html">rowmute</a></span><span class="op">(</span>aug_data <span class="op">=</span> <span class="fu"><a href="../reference/extract_yhat.html">extract_yhat</a></span><span class="op">(</span><span class="va">mod</span>, <span class="va">curr_data</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This adds the column <code>aug_data</code> to our giant data frame of
everything, containing the model predictions at every time point.</p>
<p>Finally, we can use this data to calculate a scan statistic at every
point.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scan_results</span> <span class="op">&lt;-</span> <span class="va">model_predictions</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/rowmute.html">rowmute</a></span><span class="op">(</span>scan_res <span class="op">=</span> <span class="fu"><a href="../reference/scan_eb_poisson2.html">scan_eb_poisson2</a></span><span class="op">(</span><span class="va">aug_data</span>, outcome_col <span class="op">=</span> <span class="va">count</span>, <span class="va">zones</span>, </span>
<span>                             baseline_col <span class="op">=</span> <span class="va">.fitted</span>, n_mcsim <span class="op">=</span> <span class="fl">99</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">scan_results</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 x 8</span></span></span>
<span><span class="co">#&gt;    window_tim~1 windo~2 split~3 curr_d~4 traini~5 mod        aug_data scan_res  </span></span>
<span><span class="co">#&gt;           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>           10 &lt;dbl&gt;         8 &lt;tibble&gt; &lt;tibble&gt; <span style="color: #949494;">&lt;glmerMod&gt;</span> &lt;tibble&gt; <span style="color: #949494;">&lt;scnsttst&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>           11 &lt;dbl&gt;         9 &lt;tibble&gt; &lt;tibble&gt; <span style="color: #949494;">&lt;glmerMod&gt;</span> &lt;tibble&gt; <span style="color: #949494;">&lt;scnsttst&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>           12 &lt;dbl&gt;        10 &lt;tibble&gt; &lt;tibble&gt; <span style="color: #949494;">&lt;glmerMod&gt;</span> &lt;tibble&gt; <span style="color: #949494;">&lt;scnsttst&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>           13 &lt;dbl&gt;        11 &lt;tibble&gt; &lt;tibble&gt; <span style="color: #949494;">&lt;glmerMod&gt;</span> &lt;tibble&gt; <span style="color: #949494;">&lt;scnsttst&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>           14 &lt;dbl&gt;        12 &lt;tibble&gt; &lt;tibble&gt; <span style="color: #949494;">&lt;glmerMod&gt;</span> &lt;tibble&gt; <span style="color: #949494;">&lt;scnsttst&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>           15 &lt;dbl&gt;        13 &lt;tibble&gt; &lt;tibble&gt; <span style="color: #949494;">&lt;glmerMod&gt;</span> &lt;tibble&gt; <span style="color: #949494;">&lt;scnsttst&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>           16 &lt;dbl&gt;        14 &lt;tibble&gt; &lt;tibble&gt; <span style="color: #949494;">&lt;glmerMod&gt;</span> &lt;tibble&gt; <span style="color: #949494;">&lt;scnsttst&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>           17 &lt;dbl&gt;        15 &lt;tibble&gt; &lt;tibble&gt; <span style="color: #949494;">&lt;glmerMod&gt;</span> &lt;tibble&gt; <span style="color: #949494;">&lt;scnsttst&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>           18 &lt;dbl&gt;        16 &lt;tibble&gt; &lt;tibble&gt; <span style="color: #949494;">&lt;glmerMod&gt;</span> &lt;tibble&gt; <span style="color: #949494;">&lt;scnsttst&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>           19 &lt;dbl&gt;        17 &lt;tibble&gt; &lt;tibble&gt; <span style="color: #949494;">&lt;glmerMod&gt;</span> &lt;tibble&gt; <span style="color: #949494;">&lt;scnsttst&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ... with abbreviated variable names 1: window_time_id, 2: window_space_id,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   3: split_id, 4: curr_data, 5: training_data</span></span></span></code></pre></div>
<p>And now we have our results! A list of the scan statistic at every
point in time. Once we have the results, there’s a couple things we can
do with them.</p>
<p>First, we can extract information about the top cluster at every time
point, using the <code>report_top_clusters</code> function.We’ll then
<code>unnest</code> the resulting data frame to get the information out
as a single data frame.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">top_clusters_over_time</span> <span class="op">&lt;-</span> <span class="va">scan_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/rowmute.html">rowmute</a></span><span class="op">(</span>top_cluster <span class="op">=</span> <span class="fu"><a href="../reference/report_top_clusters.html">report_top_clusters</a></span><span class="op">(</span><span class="va">scan_res</span>, <span class="va">score</span>, max_reported <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">window_time_id</span>, <span class="va">top_cluster</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">top_cluster</span><span class="op">)</span></span></code></pre></div>
<p>Let’s add back in the information about the year and the counties
affected:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">years</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">NM_data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id_time"</span>, <span class="st">"year"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">top_clusters_over_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">top_clusters_over_time</span>, <span class="va">years</span>, </span>
<span>                                    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"window_time_id"</span> <span class="op">=</span> <span class="st">"id_time"</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">top_clusters_over_time</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/rowmute.html">rowmute</a></span><span class="op">(</span>counties <span class="op">=</span> <span class="va">NM_county_sf</span><span class="op">$</span><span class="va">county</span><span class="op">[</span><span class="va">zones</span><span class="op">[[</span><span class="va">zone</span><span class="op">]</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">duration</span>, <span class="va">score</span>, <span class="va">mc_pvalue</span>, <span class="va">counties</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/hoist.html" class="external-link">unnest_wider</a></span><span class="op">(</span><span class="va">counties</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 x 14</span></span></span>
<span><span class="co">#&gt;     year duration score mc_pva~1 ...1  ...2  ...3  ...4  ...5  ...6  ...7  ...8 </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>  <span style="text-decoration: underline;">1</span>982        1  5.21     0.21 curry roos~ <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>  <span style="text-decoration: underline;">1</span>983        2  5.42     0.19 curry roos~ <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>  <span style="text-decoration: underline;">1</span>984        5  5.57     0.17 bern~ losa~ mora  rioa~ sand~ sanm~ sant~ taos </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>  <span style="text-decoration: underline;">1</span>985        1  6.82     0.08 bern~ catr~ dona~ linc~ sand~ sier~ soco~ torr~</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>  <span style="text-decoration: underline;">1</span>986        2  7.53     0.01 bern~ catr~ dona~ linc~ sand~ sant~ sier~ soco~</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>  <span style="text-decoration: underline;">1</span>987        2 10.3      0.01 colf~ guad~ hard~ losa~ mora  sanm~ sant~ taos </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>  <span style="text-decoration: underline;">1</span>988        3  9.68     0.01 colf~ deba~ guad~ hard~ losa~ mora  quay  sanm~</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>  <span style="text-decoration: underline;">1</span>989        4  7.87     0.04 losa~ sant~ <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>  <span style="text-decoration: underline;">1</span>990        5  5.66     0.11 colf~ guad~ hard~ losa~ mora  quay  sanm~ sant~</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>  <span style="text-decoration: underline;">1</span>991       17  3.78     0.6  sier~ <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ... with 2 more variables: ...9 &lt;chr&gt;, ...10 &lt;chr&gt;, and abbreviated variable</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   name 1: mc_pvalue</span></span></span></code></pre></div>
<p>Interestingly, we see that in addition to the cluster identified in
1989, several other, stronger clusters were detected in previous years.
This includes large clusters in 1987 and 1988, and a cluster in 1985
that is nearly as strong as the one in 1989, but includes neither of the
counties identified in 1989. This suggests that the potential cluster in
1989 occurred by chance, not withstanding the low p-values calculated by
the alarm function. That agrees with the findings of Kuldorff, 1998, who
also concluded that the cluster detected in 1986-1989 most likely
occured by chance. As a result, we should probably go back and
re-examine our model, and see if it’s adequately capturing the trends in
the data over time.</p>
<p>We could also look at trends in the cluster over time. We’re
interested in the rates in Los Alamos and Sante Fe counties, which
corresponds to zone number #132. We can use
<code>report_top_clusters</code> to do this as well - we’ll first
extract information about all the clusters, and then filter to the ones
for zone #132.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trends_in_zone132</span> <span class="op">&lt;-</span> <span class="va">scan_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/rowmute.html">rowmute</a></span><span class="op">(</span>all_clusters <span class="op">=</span> <span class="fu"><a href="../reference/report_top_clusters.html">report_top_clusters</a></span><span class="op">(</span><span class="va">scan_res</span>, <span class="va">score</span>, max_reported <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">window_time_id</span>, <span class="va">all_clusters</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">all_clusters</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">zone</span> <span class="op">==</span> <span class="fl">132</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">years</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"window_time_id"</span> <span class="op">=</span> <span class="st">"id_time"</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">trends_in_zone132</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">mc_pvalue</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="statsurv_overview_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="refining-our-approach">Refining our approach<a class="anchor" aria-label="anchor" href="#refining-our-approach"></a>
</h3>
<p>One of the strength of <code>statsurv</code> is the ability to swap
out bits and pieces of your analysis while keeping the rest intact. As a
simple example, we can switch from using a poisson-based alarm function,
to using a negative binomial-based alarm function:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Use the negative binomial scan function instead of the expectation-based poisson</span></span>
<span><span class="va">nb_scan_results</span> <span class="op">&lt;-</span> <span class="va">model_predictions</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/rowmute.html">rowmute</a></span><span class="op">(</span>scan_res <span class="op">=</span> <span class="fu"><a href="../reference/scan_eb_negbin2.html">scan_eb_negbin2</a></span><span class="op">(</span><span class="va">aug_data</span>, outcome_col <span class="op">=</span> <span class="va">count</span>, <span class="va">zones</span>, </span>
<span>                                     baseline_col <span class="op">=</span> <span class="va">.fitted</span>, n_mcsim <span class="op">=</span> <span class="fl">99</span>,</span>
<span>                                     theta_col <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can also use a CUSUM alarm function, instead of a scan-type alarm
function:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cusum_results</span> <span class="op">&lt;-</span> <span class="va">model_predictions</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/rowmute.html">rowmute</a></span><span class="op">(</span>cumusm_res <span class="op">=</span> <span class="fu"><a href="../reference/parallel_cusum_poisson2.html">parallel_cusum_poisson2</a></span><span class="op">(</span><span class="va">aug_data</span>, <span class="va">count</span>, <span class="va">.fitted</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can also swap out how we’re preforming our modeling.
<code>lm</code>, <code>glm</code>, <code>INLA</code>, <code>lme4</code>,
<code>ARIMA</code>, and <code>INLA</code> will all work without
modification, as will any other model that has an <code>augment</code>
function.</p>
<p>Let’s get rid of the random effects and fit our data using a regular
glm model:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_fits</span> <span class="op">&lt;-</span> <span class="va">windowed_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/rowmute.html">rowmute</a></span><span class="op">(</span>training_data <span class="op">=</span> <span class="fu"><a href="../reference/prepare_training_data.html">prepare_training_data</a></span><span class="op">(</span><span class="va">curr_data</span>, </span>
<span>                                                outcome_col <span class="op">=</span> <span class="va">count</span>,</span>
<span>                                                split_id <span class="op">=</span> <span class="va">split_id</span>, </span>
<span>                                                prep_strategy <span class="op">=</span> <span class="st">"NA"</span><span class="op">)</span>,</span>
<span>          mod <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">count</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">year</span> <span class="op">-</span> <span class="fl">1985</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">population</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                     family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>,</span>
<span>                     data <span class="op">=</span> <span class="va">training_data</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Note that we have to use <code>prep_strategy = "NA"</code> and
<code>control.predictor=list(compute = TRUE)</code> in order to be able
to extract accurate predictions from the glmer model.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_fits</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/rowmute.html">rowmute</a></span><span class="op">(</span>aug_data <span class="op">=</span> <span class="fu"><a href="../reference/extract_yhat.html">extract_yhat</a></span><span class="op">(</span><span class="va">mod</span>, <span class="va">curr_data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 x 7</span></span></span>
<span><span class="co">#&gt;    window_time_id window_space_id split_id curr_data training_d~1 mod   aug_data</span></span>
<span><span class="co">#&gt;             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;lis&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>             10 <span style="color: #949494;">&lt;dbl [32]&gt;</span>             8 &lt;tibble&gt;  &lt;tibble&gt;     <span style="color: #949494;">&lt;glm&gt;</span> &lt;tibble&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>             11 <span style="color: #949494;">&lt;dbl [32]&gt;</span>             9 &lt;tibble&gt;  &lt;tibble&gt;     <span style="color: #949494;">&lt;glm&gt;</span> &lt;tibble&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>             12 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            10 &lt;tibble&gt;  &lt;tibble&gt;     <span style="color: #949494;">&lt;glm&gt;</span> &lt;tibble&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>             13 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            11 &lt;tibble&gt;  &lt;tibble&gt;     <span style="color: #949494;">&lt;glm&gt;</span> &lt;tibble&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>             14 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            12 &lt;tibble&gt;  &lt;tibble&gt;     <span style="color: #949494;">&lt;glm&gt;</span> &lt;tibble&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>             15 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            13 &lt;tibble&gt;  &lt;tibble&gt;     <span style="color: #949494;">&lt;glm&gt;</span> &lt;tibble&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>             16 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            14 &lt;tibble&gt;  &lt;tibble&gt;     <span style="color: #949494;">&lt;glm&gt;</span> &lt;tibble&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>             17 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            15 &lt;tibble&gt;  &lt;tibble&gt;     <span style="color: #949494;">&lt;glm&gt;</span> &lt;tibble&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>             18 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            16 &lt;tibble&gt;  &lt;tibble&gt;     <span style="color: #949494;">&lt;glm&gt;</span> &lt;tibble&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>             19 <span style="color: #949494;">&lt;dbl [32]&gt;</span>            17 &lt;tibble&gt;  &lt;tibble&gt;     <span style="color: #949494;">&lt;glm&gt;</span> &lt;tibble&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ... with abbreviated variable name 1: training_data</span></span></span></code></pre></div>
<p>The ability to swap out different parts of a surveillance system
without having to change other parts makes it easier to improve and
refine your surveillance system as you are developing it.</p>
</div>
</div>
<div class="section level2">
<h2 id="other-features">Other features<a class="anchor" aria-label="anchor" href="#other-features"></a>
</h2>
<p>There are a number of other features inside the <code>statsurv</code>
package that might be useful depending on what you’re trying to do. Here
are a few of them:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Applying the same model to different spatial
locations</strong>: Some models, such as many ARIMA models, can only
handle a single spatial location at a time. The
<code>window_id_time</code> function can include each spatial location
in a separate window. Then you can fit a model on each window, and then
combine all the locations together using the <code>collapse_all</code>
function.</p></li>
<li><p><strong>Friendlier ARIMA models</strong>: ARIMA (Autoregressive
Integrated Moving Average) models are widely used to analyze time
series. There are a number of ways to fit ARIMA models in R, but most of
them use very different arguments and specifications than other types of
models, such <code>lm</code> or <code>glm</code> models.
<code>arima_tidy</code> is a function that allows use to fit ARIMA
models with covariates using formulas, instead of passing in a matrix of
regressors.</p></li>
<li><p><strong>Surveillance Residuals</strong>: In statistical
surveillance, “surveillance residuals” are defined as the difference
between observed data for a new time period and the predictions from a
model fit using previous time periods. The key difference from ordinary
model residuals is that surveillance residuals are never calculated for
data points used to fit the model. In theory, examining surveillance
residuals should allow statistical methods to detect outbreaks or
clusters more rapidly, since the model used to predict baseline
estimates is not affected by any current outbreaks. In practice, it is
still an open question whether using surveillance residuals over
ordinary residuals provides any appreciable benefit.
<code>calculate_surveillance_residuals</code> takes a set of data frames
and combines the most recent time period or time periods from each one.
If the data frames contain the estimates from sequentially fitting a
model, then the new set of data frames contains the surveillance
residuals from the series of model fits.</p></li>
<li><p><strong>Secondary Clusters</strong>: In addition to reporting the
most likely cluster in the study area, scan statistics can be used to
identify any independent secondary clusters that exist. In order to
identify any secondary clusters, we must remove information about
clusters that are almost identical to the primary cluster. Calling the
function <code>remove_overlapping_clusters</code> before running
<code>report_top_clusters</code> will identify these independent
secondary clusters.</p></li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Paul Romer Present.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
